<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
    <title>Gesti√≥n de Galer√≠a - Liga SSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; }
        .font-sport { font-family: 'Chakra Petch', sans-serif; }
        .input-admin { width: 100%; background: #f8fafc; border: 1px solid #cbd5e1; padding: 8px; border-radius: 8px; font-size: 0.9rem; outline: none; transition: all 0.2s; }
        .input-admin:focus { border-color: #4f46e5; background: white; }
        .file-upload-label { border: 2px dashed #cbd5e1; padding: 20px; display: block; text-align: center; cursor: pointer; border-radius: 12px; font-weight: bold; color: #64748b; transition: all 0.3s; background: white; }
        .file-upload-label:hover { background: #e0e7ff; color: #4f46e5; border-color: #4f46e5; }
    </style>
</head>
<body class="p-6 md:p-10 bg-slate-100 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-xl border-l-8 border-indigo-600">
            <div>
                <h1 class="text-2xl font-black font-sport text-indigo-900 uppercase italic">üì∏ Gesti√≥n de Galer√≠a</h1>
                <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Sube y elimina fotos del sitio p√∫blico</p>
            </div>
            <button onclick="window.location.href='admin_dashboard.html'" class="bg-slate-200 text-slate-600 px-6 py-3 rounded-xl font-bold text-xs uppercase hover:bg-slate-300 transition">
                ‚¨Ö Volver al Panel
            </button>
        </header>

        <div class="bg-white p-6 rounded-3xl shadow-lg mb-8 border border-slate-200">
            <h3 class="font-bold text-slate-700 mb-4 uppercase text-sm">Subir Nueva Foto</h3>
            <div class="grid md:grid-cols-12 gap-6 items-start">
                
                <div class="md:col-span-12">
                    <label class="file-upload-label" id="drop-area">
                        <input type="file" id="img-input" class="hidden" accept="image/*" onchange="previewAndSave(this)">
                        <span id="upload-text" class="text-sm">üìÇ Toca para subir foto (Sin descripci√≥n)</span>
                        <img id="img-preview" class="hidden mt-3 max-h-32 mx-auto rounded-lg shadow-md">
                    </label>
                </div>

            </div>
        </div>

        <div class="mb-4 flex justify-between items-end">
            <h3 class="font-black text-xl text-indigo-900 uppercase italic">Fotos Actuales (<span id="photo-count">0</span>)</h3>
            <button onclick="deleteAll()" class="text-rose-500 text-xs font-bold hover:underline">Borrar Todo</button>
        </div>
        
        <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6">
            </div>
    </div>

    <script src="assets/js/data.js"></script>

    <script>
        // 1. SEGURIDAD
        const role = sessionStorage.getItem('userRole');
        if(!role) {
            alert("Acceso denegado. Inicia sesi√≥n primero.");
            window.location.href = 'index.html';
        }

        // 2. CARGAR BASE DE DATOS
        let db = {};
        const localDB = localStorage.getItem('ligaData');
        
        if (localDB) {
            try { db = JSON.parse(localDB); } catch(e) { console.error("Error DB", e); }
        }
        
        // --- CORRECCI√ìN: Si no hay fotos guardadas, importar las de data.js ---
        if (!db.galeria || db.galeria.length === 0) {
            // Verificar si data.js tiene galer√≠a
            if(window.db && window.db.galeria) {
                // Convertir formato simple a objeto si es necesario
                db.galeria = window.db.galeria.map(item => {
                    return typeof item === 'string' ? { img: item, caption: '' } : item;
                });
                // Guardar la sincronizaci√≥n inmediatamente
                localStorage.setItem('ligaData', JSON.stringify(db));
            } else {
                db.galeria = [];
            }
        }

        // 3. FUNCI√ìN DE GUARDADO AUTOM√ÅTICO
        function previewAndSave(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    
                    // Guardar directamente
                    db.galeria.push({
                        img: base64,
                        caption: ""
                    });

                    localStorage.setItem('ligaData', JSON.stringify(db));
                    renderGallery();
                    input.value = ""; // Limpiar input para poder subir la misma si se desea
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 4. MOSTRAR GALER√çA
        function renderGallery() {
            const grid = document.getElementById('gallery-grid');
            const count = document.getElementById('photo-count');
            
            count.innerText = db.galeria.length;
            grid.innerHTML = "";

            if (db.galeria.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-slate-400 font-bold text-sm py-10">No hay fotos en la galer√≠a.</p>`;
                return;
            }

            // Mostrar en orden inverso (nuevas primero)
            db.galeria.slice().reverse().forEach((item, index) => {
                // Calcular √≠ndice real porque estamos invirtiendo la vista
                const realIndex = db.galeria.length - 1 - index;
                
                const imgSrc = item.img || item; // Soporte para formato antiguo y nuevo

                const card = document.createElement('div');
                card.className = "bg-white p-2 rounded-2xl shadow-sm group relative border border-slate-100";
                card.innerHTML = `
                    <div class="relative overflow-hidden rounded-xl aspect-square">
                        <img src="${imgSrc}" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-500">
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                            <button onclick="deletePhoto(${realIndex})" class="bg-rose-600 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase hover:bg-rose-700 shadow-lg transform hover:scale-105 transition">Eliminar</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 5. ELIMINAR FOTO
        function deletePhoto(index) {
            if(confirm("¬øBorrar foto?")) {
                db.galeria.splice(index, 1);
                localStorage.setItem('ligaData', JSON.stringify(db));
                renderGallery();
            }
        }

        function deleteAll() {
            if(confirm("‚ö†Ô∏è ¬øBorrar TODAS las fotos?")) {
                db.galeria = [];
                localStorage.setItem('ligaData', JSON.stringify(db));
                renderGallery();
            }
        }

        renderGallery();

    </script>
</body>
</html>